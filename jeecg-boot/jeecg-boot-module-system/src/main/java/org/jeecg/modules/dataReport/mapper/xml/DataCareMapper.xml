<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.jeecg.modules.dataReport.mapper.DataCareMapper">

    <select id="getAllBlnoByErp" resultType="org.jeecg.modules.dataReport.entity.BlDataCare">
		SELECT
				ordercode,
				TTT.BOLCODE,
				ODATE,
				(
				CASE sched
				WHEN '10' THEN
				'岛内'
				ELSE
				'岛外'
				END
				) AS sched,
				(
				SELECT
				SUM (qty) AS cntqty
				FROM
				oms_order_container tt2
				WHERE
				TT2.ORDERID = TTT.ORDERID
				) AS connum,
				ctnsum AS containertype,
				ttt5.langname1 AS payer,
				ttt6.langname1 AS salesman,
				(
				CASE busitype
				WHEN '10' THEN
				'进口'
				ELSE
				'出口'
				END
				) AS salestype,
				TTT4.tm_odate AS tm_odate,
				DEPOT AS wharf
				FROM
				(
				SELECT
				orderid,
				ordercode,
				bolcode,
				busitype,
				ARAPCCODE,
				sales,
				ODATE,
				ctnsum,
				DEPOT,
				WCODE,
				(
				SELECT
				code
				FROM
				dictinfo
				WHERE
				dicticode = 'DISPATCH'
				AND code IN (
				SELECT
				ditype
				FROM
				dictinfo
				WHERE
				dicticode = 'LOG.OMS.WHARF'
				AND code = DEPOT
				)
				) AS sched,
				sendstatus
				FROM
				oms_order
				WHERE
				(
				(
				(
				(
					sheetcode = 'LOG.OMS.ORDER'
				)

				)

				)

				)
				AND (
				orderid IN (
				SELECT
				orderid
				FROM
				(
				SELECT
				tm.tm_odate,
				oo.orderid,
				ROW_NUMBER () OVER (
				PARTITION BY oo.orderid
				ORDER BY
				tm.tm_odate DESC
				) AS s
				FROM
				task_milestone tm,
				oms_task ot,
				oms_order oo
				WHERE
				tm.taskid = ot.taskid
				AND ot.orderid = oo.orderid
				AND ot.task_type = 'CU'
				AND tm.tm_odate IS NOT NULL
				AND

				   ${ew.sqlSegment}

				)
				WHERE
				s = 1
				)
				)
				AND (
				innerflags IS NULL
				OR innerflags = 0
				)
				ORDER BY
				predate DESC
				) ttt
				LEFT JOIN (
					SELECT
						MAX (TASK.TM_ODATE) AS TM_ODATE,
						TASK.TM_MBLNO
					FROM
						task_milestone task
					GROUP BY
						TM_MBLNO
				) ttt4 ON ttt.bolcode = ttt4.tm_mblno
				LEFT JOIN ccode ttt5 ON ttt.ARAPCCODE = ttt5.ccode
				LEFT JOIN wcode ttt6 ON ttt.WCODE = ttt6.wcode
				WHERE
				ttt.sched IN (10, 20)




	</select>
    <select id="getTmsBlNoDatas" resultType="java.util.HashMap">

		SELECT * FROM (
				SELECT
					t.bl_no,
					CASE
				WHEN ttt.cnum IS NULL THEN
					0
				ELSE
					ttt.cnum
				END AS cnum
				FROM
					order_info t
				LEFT JOIN (
					SELECT
						tt.order_id,
						COUNT(*) AS cnum
					FROM
						order_container_info tt
					WHERE
						tt.is_valid = 1
					AND tt.container_status = 1
					GROUP BY
						tt.order_id
				) ttt ON t.order_id = ttt.order_id
				WHERE
					t.is_valid = 1
				AND t.dispatch_center IS NULL


				UNION
					SELECT
						bl_no, 0 AS cunm
					FROM
						order_bulk_info t1
					WHERE
						t1.is_valid = 1
					AND t1.erp_order_id IS NOT NULL
					AND t1.order_source = 2

				) ttrules

	</select>
</mapper>
